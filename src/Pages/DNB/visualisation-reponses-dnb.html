<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisation des r√©ponses - DNB Technologie</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            padding: 25px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }
        
        .stat-box strong {
            display: block;
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .stat-box span {
            font-size: 1.8em;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-refresh {
            background-color: #3498db;
            color: white;
        }
        
        .btn-refresh:hover {
            background-color: #2980b9;
        }
        
        .btn-download {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-download:hover {
            background-color: #229954;
        }
        
        .btn-clear {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-clear:hover {
            background-color: #c0392b;
        }
        
        .content {
            padding: 25px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #95a5a6;
            font-size: 1.2em;
        }
        
        .student-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .student-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-color: #3498db;
        }
        
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .student-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .student-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .student-class {
            background-color: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .submission-time {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .responses-grid {
            display: grid;
            gap: 20px;
        }
        
        .question-block {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .question-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .response-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .response-label {
            font-weight: 600;
            color: #34495e;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .response-value {
            color: #2c3e50;
            padding: 8px;
            background-color: #fff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            min-height: 30px;
        }
        
        .response-value.empty {
            color: #e74c3c;
            font-style: italic;
        }
        
        .checkbox-response {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: 600;
        }
        
        .checkbox-response.checked {
            background-color: #27ae60;
            color: white;
        }
        
        .checkbox-response.unchecked {
            background-color: #e74c3c;
            color: white;
        }
        
        .search-filter {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .student-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Tableau de bord - DNB Technologie</h1>
            <p>Visualisation des r√©ponses des √©l√®ves - Trottinette √âlectrique</p>
        </div>
        
        <div class="controls">
            <div class="stats">
                <div class="stat-box">
                    <strong>Total de r√©ponses</strong>
                    <span id="totalCount">0</span>
                </div>
                <div class="stat-box" style="border-left-color: #27ae60;">
                    <strong>Derni√®re mise √† jour</strong>
                    <span id="lastUpdate" style="font-size: 1em;">-</span>
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn btn-refresh" onclick="loadResponses()">
                    üîÑ Actualiser
                </button>
                <button class="btn btn-download" onclick="downloadCSV()">
                    üì• T√©l√©charger CSV
                </button>
                <button class="btn btn-clear" onclick="clearFilter()">
                    üóëÔ∏è Effacer le filtre
                </button>
            </div>
        </div>
        
        <div class="content">
            <div id="alertBox" class="alert"></div>
            
            <div class="search-filter">
                <input type="text" 
                       id="searchInput" 
                       class="search-input" 
                       placeholder="üîç Rechercher par nom, pr√©nom ou classe..."
                       oninput="filterResults()">
            </div>
            
            <div id="loadingDiv" class="loading">
                <div class="spinner"></div>
                <p>Chargement des r√©ponses...</p>
            </div>
            
            <div id="noDataDiv" class="no-data" style="display: none;">
                <p>üì≠ Aucune r√©ponse disponible pour le moment</p>
            </div>
            
            <div id="responsesContainer"></div>
        </div>
    </div>

    <script>
        // Configuration Firebase (identique au formulaire)
        const firebaseConfig = {
            apiKey: "AIzaSyDIvzEk0xKVdRC0r9D_tBGnKPX29Fqkem4",
            authDomain: "form-results-b285b.firebaseapp.com",
            projectId: "form-results-b285b",
            storageBucket: "form-results-b285b.firebasestorage.app",
            messagingSenderId: "662462446647",
            appId: "1:662462446647:web:0fe6315cc0c189185513b2"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allResponses = [];

        // Charger les r√©ponses au d√©marrage
        window.addEventListener('DOMContentLoaded', function() {
            loadResponses();
        });

        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = 'alert ' + type;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 4000);
        }

        async function loadResponses() {
            const loadingDiv = document.getElementById('loadingDiv');
            const noDataDiv = document.getElementById('noDataDiv');
            const container = document.getElementById('responsesContainer');
            
            loadingDiv.style.display = 'block';
            noDataDiv.style.display = 'none';
            container.innerHTML = '';
            
            try {
                const snapshot = await db.collection('dnb_trottinette')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                allResponses = [];
                
                snapshot.forEach(doc => {
                    allResponses.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                loadingDiv.style.display = 'none';
                
                if (allResponses.length === 0) {
                    noDataDiv.style.display = 'block';
                } else {
                    displayResponses(allResponses);
                    updateStats();
                    showAlert('‚úÖ Donn√©es charg√©es avec succ√®s !', 'success');
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                loadingDiv.style.display = 'none';
                showAlert('‚ùå Erreur lors du chargement des donn√©es: ' + error.message, 'error');
            }
        }

        function displayResponses(responses) {
            const container = document.getElementById('responsesContainer');
            container.innerHTML = '';
            
            if (responses.length === 0) {
                document.getElementById('noDataDiv').style.display = 'block';
                return;
            }
            
            document.getElementById('noDataDiv').style.display = 'none';
            
            responses.forEach((response, index) => {
                const card = createStudentCard(response, index + 1);
                container.appendChild(card);
            });
        }

        function createStudentCard(data, index) {
            const card = document.createElement('div');
            card.className = 'student-card';
            
            const timestamp = data.timestamp ? 
                new Date(data.timestamp.toDate()).toLocaleString('fr-FR') : 
                'Date inconnue';
            
            card.innerHTML = `
                <div class="student-header">
                    <div class="student-info">
                        <div class="student-name">${index}. ${data.studentName || 'Nom non renseign√©'}</div>
                        <div class="student-class">${data.studentClass || 'Classe non renseign√©e'}</div>
                    </div>
                    <div class="submission-time">üìÖ ${timestamp}</div>
                </div>
                
                <div class="responses-grid">
                    <!-- Question 1 -->
                    <div class="question-block">
                        <div class="question-title">Question 1 - Avantages et inconv√©nients (4 points)</div>
                        <div class="response-item">
                            <div class="response-label">Avantage 1:</div>
                            <div class="response-value ${!data.q1_avantage1 ? 'empty' : ''}">${data.q1_avantage1 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Avantage 2:</div>
                            <div class="response-value ${!data.q1_avantage2 ? 'empty' : ''}">${data.q1_avantage2 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Avantage 3:</div>
                            <div class="response-value ${!data.q1_avantage3 ? 'empty' : ''}">${data.q1_avantage3 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Inconv√©nient:</div>
                            <div class="response-value ${!data.q1_inconvenient ? 'empty' : ''}">${data.q1_inconvenient || 'Non renseign√©'}</div>
                        </div>
                    </div>
                    
                    <!-- Question 2 -->
                    <div class="question-block">
                        <div class="question-title">Question 2 - Solutions techniques (7 points)</div>
                        <div class="response-item">
                            <div class="response-label">Avertir:</div>
                            <div class="response-value ${!data.q2_avertir ? 'empty' : ''}">${data.q2_avertir || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Avancer (1):</div>
                            <div class="response-value ${!data.q2_avancer1 ? 'empty' : ''}">${data.q2_avancer1 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Avancer (2):</div>
                            <div class="response-value ${!data.q2_avancer2 ? 'empty' : ''}">${data.q2_avancer2 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Avancer (3):</div>
                            <div class="response-value ${!data.q2_avancer3 ? 'empty' : ''}">${data.q2_avancer3 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">√âclairer (1):</div>
                            <div class="response-value ${!data.q2_eclairer1 ? 'empty' : ''}">${data.q2_eclairer1 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">√âclairer (2):</div>
                            <div class="response-value ${!data.q2_eclairer2 ? 'empty' : ''}">${data.q2_eclairer2 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Fonction batterie:</div>
                            <div class="response-value ${!data.q2_fonction_batterie ? 'empty' : ''}">${data.q2_fonction_batterie || 'Non renseign√©'}</div>
                        </div>
                    </div>
                    
                    <!-- Question 3 -->
                    <div class="question-block">
                        <div class="question-title">Question 3 - R√®glement (4 points)</div>
                        <div class="response-item">
                            <div class="response-label">Freiner:</div>
                            <span class="checkbox-response ${data.q3_freiner ? 'checked' : 'unchecked'}">
                                ${data.q3_freiner ? '‚úì Coch√©' : '‚úó Non coch√©'}
                            </span>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Avertir:</div>
                            <span class="checkbox-response ${data.q3_avertir ? 'checked' : 'unchecked'}">
                                ${data.q3_avertir ? '‚úì Coch√©' : '‚úó Non coch√©'}
                            </span>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Avancer:</div>
                            <span class="checkbox-response ${data.q3_avancer ? 'checked' : 'unchecked'}">
                                ${data.q3_avancer ? '‚úì Coch√©' : '‚úó Non coch√©'}
                            </span>
                        </div>
                        <div class="response-item">
                            <div class="response-label">√âclairer:</div>
                            <span class="checkbox-response ${data.q3_eclairer ? 'checked' : 'unchecked'}">
                                ${data.q3_eclairer ? '‚úì Coch√©' : '‚úó Non coch√©'}
                            </span>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Batterie:</div>
                            <span class="checkbox-response ${data.q3_batterie ? 'checked' : 'unchecked'}">
                                ${data.q3_batterie ? '‚úì Coch√©' : '‚úó Non coch√©'}
                            </span>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Vitesse:</div>
                            <span class="checkbox-response ${data.q3_vitesse ? 'checked' : 'unchecked'}">
                                ${data.q3_vitesse ? '‚úì Coch√©' : '‚úó Non coch√©'}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Question 4 -->
                    <div class="question-block">
                        <div class="question-title">Question 4 - Algorigramme (6 points)</div>
                        <div class="response-item">
                            <div class="response-label">Box 1:</div>
                            <div class="response-value ${!data.q4_box1 ? 'empty' : ''}">${data.q4_box1 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Box 2:</div>
                            <div class="response-value ${!data.q4_box2 ? 'empty' : ''}">${data.q4_box2 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Box 3:</div>
                            <div class="response-value ${!data.q4_box3 ? 'empty' : ''}">${data.q4_box3 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Diamond (condition):</div>
                            <div class="response-value ${!data.q4_diamond ? 'empty' : ''}">${data.q4_diamond || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">R√©ponse 1:</div>
                            <div class="response-value ${!data.q4_reponse1 ? 'empty' : ''}">${data.q4_reponse1 || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">R√©ponse 2:</div>
                            <div class="response-value ${!data.q4_reponse2 ? 'empty' : ''}">${data.q4_reponse2 || 'Non renseign√©'}</div>
                        </div>
                    </div>
                    
                    <!-- Question 5 -->
                    <div class="question-block">
                        <div class="question-title">Question 5 - Programme (4 points)</div>
                        <div class="response-item">
                            <div class="response-label">Autoriser l'acc√©l√©ration:</div>
                            <div class="response-value ${!data.q5_autoriser ? 'empty' : ''}">${data.q5_autoriser || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">G√¢chette de freinage:</div>
                            <div class="response-value ${!data.q5_gachette ? 'empty' : ''}">${data.q5_gachette || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Bouton d'√©clairage:</div>
                            <div class="response-value ${!data.q5_bouton ? 'empty' : ''}">${data.q5_bouton || 'Non renseign√©'}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Ne pas autoriser l'acc√©l√©ration:</div>
                            <div class="response-value ${!data.q5_ne_pas_autoriser ? 'empty' : ''}">${data.q5_ne_pas_autoriser || 'Non renseign√©'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = allResponses.length;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('fr-FR');
        }

        function filterResults() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = allResponses.filter(response => {
                const name = (response.studentName || '').toLowerCase();
                const studentClass = (response.studentClass || '').toLowerCase();
                
                return name.includes(searchTerm) || studentClass.includes(searchTerm);
            });
            
            displayResponses(filtered);
        }

        function clearFilter() {
            document.getElementById('searchInput').value = '';
            displayResponses(allResponses);
        }

        function downloadCSV() {
            if (allResponses.length === 0) {
                showAlert('‚ö†Ô∏è Aucune donn√©e √† t√©l√©charger', 'error');
                return;
            }
            
            // En-t√™tes du CSV
            const headers = [
                'Timestamp',
                'Nom et Pr√©nom',
                'Classe',
                'Q1 - Avantage 1',
                'Q1 - Avantage 2',
                'Q1 - Avantage 3',
                'Q1 - Inconv√©nient',
                'Q2 - Avertir',
                'Q2 - Avancer 1',
                'Q2 - Avancer 2',
                'Q2 - Avancer 3',
                'Q2 - √âclairer 1',
                'Q2 - √âclairer 2',
                'Q2 - Fonction batterie',
                'Q3 - Freiner',
                'Q3 - Avertir',
                'Q3 - Avancer',
                'Q3 - √âclairer',
                'Q3 - Batterie',
                'Q3 - Vitesse',
                'Q4 - Box 1',
                'Q4 - Box 2',
                'Q4 - Box 3',
                'Q4 - Diamond',
                'Q4 - R√©ponse 1',
                'Q4 - R√©ponse 2',
                'Q5 - Autoriser',
                'Q5 - G√¢chette',
                'Q5 - Bouton',
                'Q5 - Ne pas autoriser'
            ];
            
            // Fonction pour √©chapper les valeurs CSV
            function escapeCSV(value) {
                if (value === null || value === undefined) return '';
                const stringValue = String(value);
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('
')) {
                    return '"' + stringValue.replace(/"/g, '""') + '"';
                }
                return stringValue;
            }
            
            // Construire les lignes du CSV
            let csvContent = headers.join(',') + '
';
            
            allResponses.forEach(response => {
                const timestamp = response.timestamp ? 
                    new Date(response.timestamp.toDate()).toLocaleString('fr-FR') : 
                    '';
                
                const row = [
                    timestamp,
                    response.studentName || '',
                    response.studentClass || '',
                    response.q1_avantage1 || '',
                    response.q1_avantage2 || '',
                    response.q1_avantage3 || '',
                    response.q1_inconvenient || '',
                    response.q2_avertir || '',
                    response.q2_avancer1 || '',
                    response.q2_avancer2 || '',
                    response.q2_avancer3 || '',
                    response.q2_eclairer1 || '',
                    response.q2_eclairer2 || '',
                    response.q2_fonction_batterie || '',
                    response.q3_freiner ? 'Oui' : 'Non',
                    response.q3_avertir ? 'Oui' : 'Non',
                    response.q3_avancer ? 'Oui' : 'Non',
                    response.q3_eclairer ? 'Oui' : 'Non',
                    response.q3_batterie ? 'Oui' : 'Non',
                    response.q3_vitesse ? 'Oui' : 'Non',
                    response.q4_box1 || '',
                    response.q4_box2 || '',
                    response.q4_box3 || '',
                    response.q4_diamond || '',
                    response.q4_reponse1 || '',
                    response.q4_reponse2 || '',
                    response.q5_autoriser || '',
                    response.q5_gachette || '',
                    response.q5_bouton || '',
                    response.q5_ne_pas_autoriser || ''
                ];
                
                csvContent += row.map(escapeCSV).join(',') + '
';
            });
            
            // Cr√©er le fichier et le t√©l√©charger
            const blob = new Blob(['Ôªø' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const dateStr = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `reponses_dnb_trottinette_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('‚úÖ Fichier CSV t√©l√©charg√© avec succ√®s !', 'success');
        }
    </script>
</body>
</html>
