<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capteurs, D√©tecteurs et Signaux - Coll√®ge Moulin √† Vent</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- html2pdf.js pour l'export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .controls-container {
            max-width: 1100px;
            margin: 0 auto 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-action {
            flex: 1;
            min-width: 200px;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-save {
            background-color: #27ae60;
            color: white;
        }

        .btn-save:hover {
            background-color: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-pdf {
            background-color: #e74c3c;
            color: white;
        }

        .btn-pdf:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-json {
            background-color: #3498db;
            color: white;
        }

        .btn-json:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-reset {
            background-color: #95a5a6;
            color: white;
            flex: 0.3;
        }

        .btn-reset:hover {
            background-color: #7f8c8d;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* En-t√™te */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .college-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .competences {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        h1 {
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        /* Informations √©l√®ve */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: bold;
            color: #34495e;
            margin-bottom: 8px;
            font-size: 15px;
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Sections d'exercices */
        .section {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-subtitle {
            font-size: 16px;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 15px;
        }

        .bareme {
            font-size: 13px;
            color: #e67e22;
            font-style: italic;
            margin-bottom: 15px;
        }

        /* Tableau */
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        th {
            background-color: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 10px;
            border: 1px solid #ddd;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .table-label {
            font-weight: 600;
            color: #2c3e50;
        }

        /* Code block */
        .code-block {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            overflow-x: auto;
            line-height: 1.6;
        }

        .question-list {
            margin-top: 15px;
        }

        .question-item {
            margin-bottom: 15px;
        }

        .question-label {
            font-weight: 600;
            color: #34495e;
            margin-bottom: 5px;
        }

        /* Messages */
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 5px solid #28a745;
            display: none;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 5px solid #dc3545;
            display: none;
        }

        .required {
            color: #e74c3c;
        }

        .help-text {
            font-size: 13px;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        /* Section bonus */
        .section-bonus {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%);
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
            color: #7f8c8d;
            font-size: 12px;
        }

        .btn-import {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-import:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
            background-color: white;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .controls-container {
                flex-direction: column;
            }

            .btn-action {
                min-width: 100%;
            }
        }

        /* Style pour l'impression PDF */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .controls-container,
            .btn-action,
            .help-text {
                display: none !important;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
                padding: 20mm;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="ficheContent">
        <!-- En-t√™te -->
        <div class="header">
            <div class="college-title">Coll√®ge Moulin √† Vent - Technologie Cycle 4</div>
            <div class="competences">Comp√©tences : CT 1.2 | MSOST 1.6</div>
            <h1>üî¨ Capteurs, D√©tecteurs et Signaux</h1>
            <p class="subtitle">Exercices sur le mBot2</p>
        </div>

        <!-- Informations √©l√®ve -->
        <div class="info-grid">
            <div class="form-group">
                <label>Pr√©nom <span class="required">*</span></label>
                <input type="text" id="prenom" placeholder="Pr√©nom" required>
            </div>
            <div class="form-group">
                <label>Nom <span class="required">*</span></label>
                <input type="text" id="nom" placeholder="Nom" required>
            </div>
            <div class="form-group">
                <label>Classe <span class="required">*</span></label>
                <select id="classe" required>
                    <option value="">-- S√©lectionner une classe --</option>
                    <option value="505">505</option>
                    <option value="506">506</option>
                    <option value="507">507</option>
                    <option value="401">401</option>
                    <option value="402">402</option>
                    <option value="403">403</option>
                    <option value="404">404</option>
                    <option value="405">405</option>
                    <option value="302">302</option>
                    <option value="304">304</option>
                    <option value="305">305</option>
                    <option value="306">306</option>
                    <option value="307">307</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date <span class="required">*</span></label>
                <input type="text" id="date" placeholder="JJ/MM/AAAA" required>
            </div>
        </div>

        <!-- ===== EXERCICE 1 ===== -->
        <div class="section">
            <div class="section-title">
                ü§ñ Partie 1 : Capteurs sur le mBot2
            </div>
            <div class="section-subtitle">Exercice 2 : Identifier les capteurs du mBot2</div>            
            <p style="margin-bottom: 15px;">
                D'apr√®s la fiche d'activit√©, compl√®te les informations suivantes :
            </p>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Module du mBot2</th>
                            <th>Type (capteur/d√©tecteur)</th>
                            <th>Information fournie</th>
                            <th>Utilisation possible</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="table-label">Luminosit√©</td>
                            <td><input type="text" id="ex1_1_type" placeholder="Type"></td>
                            <td><input type="text" id="ex1_1_info" placeholder="Information"></td>
                            <td><input type="text" id="ex1_1_usage" placeholder="Utilisation"></td>
                        </tr>
                        <tr>
                            <td class="table-label">Suiveur de ligne (gauche)</td>
                            <td><input type="text" id="ex1_2_type" placeholder="Type"></td>
                            <td><input type="text" id="ex1_2_info" placeholder="Information"></td>
                            <td><input type="text" id="ex1_2_usage" placeholder="Utilisation"></td>
                        </tr>
                        <tr>
                            <td class="table-label">Suiveur de ligne (droit)</td>
                            <td><input type="text" id="ex1_3_type" placeholder="Type"></td>
                            <td><input type="text" id="ex1_3_info" placeholder="Information"></td>
                            <td><input type="text" id="ex1_3_usage" placeholder="Utilisation"></td>
                        </tr>
                        <tr>
                            <td class="table-label">Ultrason</td>
                            <td><input type="text" id="ex1_4_type" placeholder="Type"></td>
                            <td><input type="text" id="ex1_4_info" placeholder="Information"></td>
                            <td><input type="text" id="ex1_4_usage" placeholder="Utilisation"></td>
                        </tr>
                        <tr>
                            <td class="table-label">Bouton poussoir</td>
                            <td><input type="text" id="ex1_5_type" placeholder="Type"></td>
                            <td><input type="text" id="ex1_5_info" placeholder="Information"></td>
                            <td><input type="text" id="ex1_5_usage" placeholder="Utilisation"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== EXERCICE 3 ===== -->
        <div class="section">
            <div class="section-title">
                üéØ Partie 3 : Situation probl√®me
            </div>
            <div class="section-subtitle">Exercice 3 : Choisir le bon capteur</div>            
            <p style="margin-bottom: 15px;">
                Pour chaque situation, indique quel type de capteur tu utiliserais et justifie :
            </p>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Situation</th>
                            <th>Capteur choisi</th>
                            <th>Justification</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="table-label">D√©tecter si une porte est ouverte ou ferm√©e</td>
                            <td><input type="text" id="ex2_1_capteur" placeholder="Capteur"></td>
                            <td><textarea id="ex2_1_justif" placeholder="Justification" rows="2"></textarea></td>
                        </tr>
                        <tr>
                            <td class="table-label">Mesurer la vitesse pr√©cise d'un robot</td>
                            <td><input type="text" id="ex2_2_capteur" placeholder="Capteur"></td>
                            <td><textarea id="ex2_2_justif" placeholder="Justification" rows="2"></textarea></td>
                        </tr>
                        <tr>
                            <td class="table-label">Savoir si une pi√®ce est occup√©e</td>
                            <td><input type="text" id="ex2_3_capteur" placeholder="Capteur"></td>
                            <td><textarea id="ex2_3_justif" placeholder="Justification" rows="2"></textarea></td>
                        </tr>
                        <tr>
                            <td class="table-label">R√©guler l'arrosage selon l'humidit√© du sol</td>
                            <td><input type="text" id="ex2_4_capteur" placeholder="Capteur"></td>
                            <td><textarea id="ex2_4_justif" placeholder="Justification" rows="2"></textarea></td>
                        </tr>
                        <tr>
                            <td class="table-label">Compter le nombre de tours d'une roue</td>
                            <td><input type="text" id="ex2_5_capteur" placeholder="Capteur"></td>
                            <td><textarea id="ex2_5_justif" placeholder="Justification" rows="2"></textarea></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== BONUS ===== -->
        <div class="section section-bonus">
            <div class="section-title">
                üéì Bonus : Question de r√©flexion
            </div>            
            <p style="margin-bottom: 15px;">
                <strong>Dans la vie quotidienne, cite 3 objets connect√©s ou syst√®mes automatis√©s que tu utilises 
                et identifie quel(s) type(s) de capteur(s) ils pourraient contenir :</strong>
            </p>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Objet/Syst√®me</th>
                            <th>Capteur(s) identifi√©(s)</th>
                            <th>Type d'information</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" id="bonus_1_objet" placeholder="Objet/Syst√®me"></td>
                            <td><input type="text" id="bonus_1_capteur" placeholder="Capteur(s)"></td>
                            <td><input type="text" id="bonus_1_type" placeholder="Type d'info"></td>
                        </tr>
                        <tr>
                            <td><input type="text" id="bonus_2_objet" placeholder="Objet/Syst√®me"></td>
                            <td><input type="text" id="bonus_2_capteur" placeholder="Capteur(s)"></td>
                            <td><input type="text" id="bonus_2_type" placeholder="Type d'info"></td>
                        </tr>
                        <tr>
                            <td><input type="text" id="bonus_3_objet" placeholder="Objet/Syst√®me"></td>
                            <td><input type="text" id="bonus_3_capteur" placeholder="Capteur(s)"></td>
                            <td><input type="text" id="bonus_3_type" placeholder="Type d'info"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Boutons de contr√¥le -->
        <div class="controls-container">
            <button type="button" id="saveBtn" class="btn-action btn-save">
                üíæ Envoyez vos r√©ponses
            </button>
            <button type="button" id="exportJsonBtn" class="btn-action btn-json">
                üì¶ Enregistrez vos r√©ponses
            </button>
            <button type="button" id="importJsonBtn" class="btn-action btn-import">
                üì• Chargez vos r√©ponses
            </button>
            <button type="button" id="resetBtn" class="btn-action btn-reset">
                üîÑ R√©initialiser
            </button>
        </div>

        <!-- Messages de feedback -->
        <div id="successMessage" class="success-message">
            ‚úÖ <strong>Succ√®s !</strong> Votre fiche a √©t√© enregistr√©e avec succ√®s dans Firebase.
        </div>
        <div id="errorMessage" class="error-message">
            ‚ùå <strong>Erreur !</strong> <span id="errorText"></span>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p><strong>üéØ Comp√©tences travaill√©es :</strong></p>
            <p>CT 1.2 : Mesurer des grandeurs de mani√®re directe ou indirecte</p>
            <p>MSOST 1.6 : Analyser le comportement attendu d'un syst√®me r√©el</p>
            <p style="margin-top: 10px;">Coll√®ge Moulin √† vent ‚Äì Technologie au coll√®ge</p>
        </div>
    </div>

    <script>
        
        // ============================================
        // CONFIGURATION FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDIvzEk0xKVdRC0r9D_tBGnKPX29Fqkem4",
            authDomain: "form-results-b285b.firebaseapp.com",
            projectId: "form-results-b285b",
            storageBucket: "form-results-b285b.firebasestorage.app",
            messagingSenderId: "662462446647",
            appId: "1:662462446647:web:0fe6315cc0c189185513b2"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        console.log('‚úÖ Firebase initialis√©');

        // ============================================
        // FONCTION DE COLLECTE DES DONN√âES
        // ============================================
        function collectFormData() {
            return {
                // Informations √©l√®ve
                prenom: document.getElementById('prenom').value.trim(),
                nom: document.getElementById('nom').value.trim(),
                classe: document.getElementById('classe').value.trim(),
                date: document.getElementById('date').value.trim(),

                // Exercice 1 - Capteurs mBot2 (5 modules)
                exercice1: {
                    luminosite: {
                        module: "Luminosit√©",
                        type: document.getElementById('ex1_1_type').value.trim(),
                        information: document.getElementById('ex1_1_info').value.trim(),
                        utilisation: document.getElementById('ex1_1_usage').value.trim()
                    },
                    suiveurGauche: {
                        module: "Suiveur de ligne (gauche)",
                        type: document.getElementById('ex1_2_type').value.trim(),
                        information: document.getElementById('ex1_2_info').value.trim(),
                        utilisation: document.getElementById('ex1_2_usage').value.trim()
                    },
                    suiveurDroit: {
                        module: "Suiveur de ligne (droit)",
                        type: document.getElementById('ex1_3_type').value.trim(),
                        information: document.getElementById('ex1_3_info').value.trim(),
                        utilisation: document.getElementById('ex1_3_usage').value.trim()
                    },
                    ultrason: {
                        module: "Ultrason",
                        type: document.getElementById('ex1_4_type').value.trim(),
                        information: document.getElementById('ex1_4_info').value.trim(),
                        utilisation: document.getElementById('ex1_4_usage').value.trim()
                    },
                    bouton: {
                        module: "Bouton poussoir",
                        type: document.getElementById('ex1_5_type').value.trim(),
                        information: document.getElementById('ex1_5_info').value.trim(),
                        utilisation: document.getElementById('ex1_5_usage').value.trim()
                    }
                },

                // Exercice 2 - Choix de capteurs (5 situations)
                exercice2: {
                    situation1: {
                        situation: "D√©tecter si une porte est ouverte ou ferm√©e",
                        capteur: document.getElementById('ex2_1_capteur').value.trim(),
                        justification: document.getElementById('ex2_1_justif').value.trim()
                    },
                    situation2: {
                        situation: "Mesurer la vitesse pr√©cise d'un robot",
                        capteur: document.getElementById('ex2_2_capteur').value.trim(),
                        justification: document.getElementById('ex2_2_justif').value.trim()
                    },
                    situation3: {
                        situation: "Savoir si une pi√®ce est occup√©e",
                        capteur: document.getElementById('ex2_3_capteur').value.trim(),
                        justification: document.getElementById('ex2_3_justif').value.trim()
                    },
                    situation4: {
                        situation: "R√©guler l'arrosage selon l'humidit√© du sol",
                        capteur: document.getElementById('ex2_4_capteur').value.trim(),
                        justification: document.getElementById('ex2_4_justif').value.trim()
                    },
                    situation5: {
                        situation: "Compter le nombre de tours d'une roue",
                        capteur: document.getElementById('ex2_5_capteur').value.trim(),
                        justification: document.getElementById('ex2_5_justif').value.trim()
                    }
                },

                // Bonus - Objets connect√©s (3 exemples)
                bonus: {
                    exemple1: {
                        objet: document.getElementById('bonus_1_objet').value.trim(),
                        capteur: document.getElementById('bonus_1_capteur').value.trim(),
                        type: document.getElementById('bonus_1_type').value.trim()
                    },
                    exemple2: {
                        objet: document.getElementById('bonus_2_objet').value.trim(),
                        capteur: document.getElementById('bonus_2_capteur').value.trim(),
                        type: document.getElementById('bonus_2_type').value.trim()
                    },
                    exemple3: {
                        objet: document.getElementById('bonus_3_objet').value.trim(),
                        capteur: document.getElementById('bonus_3_capteur').value.trim(),
                        type: document.getElementById('bonus_3_type').value.trim()
                    }
                },

                // M√©tadonn√©es
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                dateSoumission: new Date().toISOString(),
                timestampLocal: Date.now()
            };
        }

        // ============================================
        // SAUVEGARDE DANS FIREBASE (VERSION S√âCURIS√âE)
        // ============================================
        let isSaving = false; // Variable globale pour √©viter les doubles clics
        
        document.getElementById('saveBtn').addEventListener('click', async function() {
            // Emp√™cher les clics multiples
            if (isSaving) {
                alert('‚è≥ Enregistrement d√©j√† en cours, veuillez patienter...');
                return;
            }
        
            // Validation des champs obligatoires
            const requiredFields = ['prenom', 'nom', 'classe', 'date'];
            
            for (let field of requiredFields) {
                const element = document.getElementById(field);
                if (!element.value.trim()) {
                    alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires (*)');
                    element.focus();
                    return;
                }
            }
        
            // D√©sactiver le bouton pendant le traitement
            isSaving = true;
            const btn = this;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Enregistrement en cours...';
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
        
            try {
                // Collecter les donn√©es
                const formData = collectFormData();
        
                // Enregistrer dans Firestore
                const docRef = await db.collection('capteurs_mbot2').add(formData);
                
                console.log('‚úÖ Fiche enregistr√©e avec ID:', docRef.id);
        
                // Afficher le message de succ√®s
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                
                // R√©initialiser le flag de modification
                formModified = false;
                
                setTimeout(() => {
                    document.getElementById('successMessage').style.display = 'none';
                }, 5000);
        
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                document.getElementById('errorText').textContent = error.message;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                
                // R√©activer le bouton en cas d'erreur
                btn.disabled = false;
                btn.textContent = originalText;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                isSaving = false;
            } finally {
                // R√©activer le bouton apr√®s 3 secondes (pour √©viter les clics rapides)
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    isSaving = false;
                }, 3000);
            }
        });

        // ============================================
        // EXPORT JSON
        // ============================================
        document.getElementById('exportJsonBtn').addEventListener('click', function() {
            const data = collectFormData();
            
            // Ajouter la date d'export
            data.exportDate = new Date().toISOString();

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `capteurs-mbot2-${data.nom || 'sans-nom'}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            console.log('‚úÖ JSON export√©');
        });

        // ============================================
        // R√âINITIALISATION
        // ============================================
        document.getElementById('resetBtn').addEventListener('click', function() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir r√©initialiser le formulaire ? Toutes les donn√©es non sauvegard√©es seront perdues.')) {
                // R√©initialiser tous les champs
                document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(field => {
                    field.value = '';
                });
                
                document.getElementById('successMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                
                console.log('‚úÖ Formulaire r√©initialis√©');
            }
        });

        // ============================================
        // IMPORT JSON
        // ============================================
        document.getElementById('importJsonBtn').addEventListener('click', function() {
            document.getElementById('jsonFileInput').click();
        });
        
        document.getElementById('jsonFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
        
            // V√©rifier que c'est bien un fichier JSON
            if (!file.name.endsWith('.json')) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un fichier JSON valide');
                return;
            }
        
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Confirmation avant d'√©craser les donn√©es
                    if (confirm('‚ö†Ô∏è Cette action va remplacer toutes les donn√©es actuelles du formulaire. Continuer ?')) {
                        // Remplir les informations √©l√®ve
                        if (data.prenom) document.getElementById('prenom').value = data.prenom;
                        if (data.nom) document.getElementById('nom').value = data.nom;
                        if (data.classe) document.getElementById('classe').value = data.classe;
                        if (data.date) document.getElementById('date').value = data.date;
        
                        // Exercice 1 - Identification des capteurs
                        if (data.exercice1) {
                            if (data.exercice1.ligne1) {
                                document.getElementById('ex1_1_type').value = data.exercice1.ligne1.type || '';
                                document.getElementById('ex1_1_info').value = data.exercice1.ligne1.information || '';
                                document.getElementById('ex1_1_signal').value = data.exercice1.ligne1.signal || '';
                                document.getElementById('ex1_1_grandeur').value = data.exercice1.ligne1.grandeur || '';
                            }
                            if (data.exercice1.ligne2) {
                                document.getElementById('ex1_2_type').value = data.exercice1.ligne2.type || '';
                                document.getElementById('ex1_2_info').value = data.exercice1.ligne2.information || '';
                                document.getElementById('ex1_2_signal').value = data.exercice1.ligne2.signal || '';
                                document.getElementById('ex1_2_grandeur').value = data.exercice1.ligne2.grandeur || '';
                            }
                            if (data.exercice1.ligne3) {
                                document.getElementById('ex1_3_type').value = data.exercice1.ligne3.type || '';
                                document.getElementById('ex1_3_info').value = data.exercice1.ligne3.information || '';
                                document.getElementById('ex1_3_signal').value = data.exercice1.ligne3.signal || '';
                                document.getElementById('ex1_3_grandeur').value = data.exercice1.ligne3.grandeur || '';
                            }
                            if (data.exercice1.ligne4) {
                                document.getElementById('ex1_4_type').value = data.exercice1.ligne4.type || '';
                                document.getElementById('ex1_4_info').value = data.exercice1.ligne4.information || '';
                                document.getElementById('ex1_4_signal').value = data.exercice1.ligne4.signal || '';
                                document.getElementById('ex1_4_grandeur').value = data.exercice1.ligne4.grandeur || '';
                            }
                            if (data.exercice1.ligne5) {
                                document.getElementById('ex1_5_type').value = data.exercice1.ligne5.type || '';
                                document.getElementById('ex1_5_info').value = data.exercice1.ligne5.information || '';
                                document.getElementById('ex1_5_signal').value = data.exercice1.ligne5.signal || '';
                                document.getElementById('ex1_5_grandeur').value = data.exercice1.ligne5.grandeur || '';
                            }
                            if (data.exercice1.ligne6) {
                                document.getElementById('ex1_6_type').value = data.exercice1.ligne6.type || '';
                                document.getElementById('ex1_6_info').value = data.exercice1.ligne6.information || '';
                                document.getElementById('ex1_6_signal').value = data.exercice1.ligne6.signal || '';
                                document.getElementById('ex1_6_grandeur').value = data.exercice1.ligne6.grandeur || '';
                            }
                        }
        
                        // Exercice 2 - Capteurs mBot2
                        if (data.exercice2) {
                            if (data.exercice2.luminosite) {
                                document.getElementById('ex2_1_type').value = data.exercice2.luminosite.type || '';
                                document.getElementById('ex2_1_info').value = data.exercice2.luminosite.information || '';
                                document.getElementById('ex2_1_usage').value = data.exercice2.luminosite.utilisation || '';
                            }
                            if (data.exercice2.suiveurGauche) {
                                document.getElementById('ex2_2_type').value = data.exercice2.suiveurGauche.type || '';
                                document.getElementById('ex2_2_info').value = data.exercice2.suiveurGauche.information || '';
                                document.getElementById('ex2_2_usage').value = data.exercice2.suiveurGauche.utilisation || '';
                            }
                            if (data.exercice2.suiveurDroit) {
                                document.getElementById('ex2_3_type').value = data.exercice2.suiveurDroit.type || '';
                                document.getElementById('ex2_3_info').value = data.exercice2.suiveurDroit.information || '';
                                document.getElementById('ex2_3_usage').value = data.exercice2.suiveurDroit.utilisation || '';
                            }
                            if (data.exercice2.ultrason) {
                                document.getElementById('ex2_4_type').value = data.exercice2.ultrason.type || '';
                                document.getElementById('ex2_4_info').value = data.exercice2.ultrason.information || '';
                                document.getElementById('ex2_4_usage').value = data.exercice2.ultrason.utilisation || '';
                            }
                            if (data.exercice2.bouton) {
                                document.getElementById('ex2_5_type').value = data.exercice2.bouton.type || '';
                                document.getElementById('ex2_5_info').value = data.exercice2.bouton.information || '';
                                document.getElementById('ex2_5_usage').value = data.exercice2.bouton.utilisation || '';
                            }
                        }
        
                        // Exercice 3 - Choix de capteurs
                        if (data.exercice3) {
                            if (data.exercice3.situation1) {
                                document.getElementById('ex3_1_capteur').value = data.exercice3.situation1.capteur || '';
                                document.getElementById('ex3_1_justif').value = data.exercice3.situation1.justification || '';
                            }
                            if (data.exercice3.situation2) {
                                document.getElementById('ex3_2_capteur').value = data.exercice3.situation2.capteur || '';
                                document.getElementById('ex3_2_justif').value = data.exercice3.situation2.justification || '';
                            }
                            if (data.exercice3.situation3) {
                                document.getElementById('ex3_3_capteur').value = data.exercice3.situation3.capteur || '';
                                document.getElementById('ex3_3_justif').value = data.exercice3.situation3.justification || '';
                            }
                            if (data.exercice3.situation4) {
                                document.getElementById('ex3_4_capteur').value = data.exercice3.situation4.capteur || '';
                                document.getElementById('ex3_4_justif').value = data.exercice3.situation4.justification || '';
                            }
                            if (data.exercice3.situation5) {
                                document.getElementById('ex3_5_capteur').value = data.exercice3.situation5.capteur || '';
                                document.getElementById('ex3_5_justif').value = data.exercice3.situation5.justification || '';
                            }
                        }
        
                        // Exercice 4 - Analyse de code
                        if (data.exercice4) {
                            document.getElementById('ex4_q1').value = data.exercice4.question1 || '';
                            document.getElementById('ex4_q2').value = data.exercice4.question2 || '';
                            document.getElementById('ex4_q3').value = data.exercice4.question3 || '';
                            document.getElementById('ex4_q4').value = data.exercice4.question4 || '';
                        }
        
                        // Exercice 5 - Mini-projet
                        if (data.exercice5) {
                            if (data.exercice5.capteur1) {
                                document.getElementById('ex5_1_choix').value = data.exercice5.capteur1.choix || '';
                                document.getElementById('ex5_1_justif').value = data.exercice5.capteur1.justification || '';
                            }
                            if (data.exercice5.capteur2) {
                                document.getElementById('ex5_2_choix').value = data.exercice5.capteur2.choix || '';
                                document.getElementById('ex5_2_justif').value = data.exercice5.capteur2.justification || '';
                            }
                            if (data.exercice5.typeInfo1) {
                                document.getElementById('ex5_3_choix').value = data.exercice5.typeInfo1.choix || '';
                                document.getElementById('ex5_3_justif').value = data.exercice5.typeInfo1.justification || '';
                            }
                            if (data.exercice5.typeInfo2) {
                                document.getElementById('ex5_4_choix').value = data.exercice5.typeInfo2.choix || '';
                                document.getElementById('ex5_4_justif').value = data.exercice5.typeInfo2.justification || '';
                            }
                            if (data.exercice5.conditionAllumage) {
                                document.getElementById('ex5_5_choix').value = data.exercice5.conditionAllumage.choix || '';
                                document.getElementById('ex5_5_justif').value = data.exercice5.conditionAllumage.justification || '';
                            }
                        }
        
                        // Bonus - Objets connect√©s
                        if (data.bonus) {
                            if (data.bonus.exemple1) {
                                document.getElementById('bonus_1_objet').value = data.bonus.exemple1.objet || '';
                                document.getElementById('bonus_1_capteur').value = data.bonus.exemple1.capteur || '';
                                document.getElementById('bonus_1_type').value = data.bonus.exemple1.type || '';
                            }
                            if (data.bonus.exemple2) {
                                document.getElementById('bonus_2_objet').value = data.bonus.exemple2.objet || '';
                                document.getElementById('bonus_2_capteur').value = data.bonus.exemple2.capteur || '';
                                document.getElementById('bonus_2_type').value = data.bonus.exemple2.type || '';
                            }
                            if (data.bonus.exemple3) {
                                document.getElementById('bonus_3_objet').value = data.bonus.exemple3.objet || '';
                                document.getElementById('bonus_3_capteur').value = data.bonus.exemple3.capteur || '';
                                document.getElementById('bonus_3_type').value = data.bonus.exemple3.type || '';
                            }
                        }
        
                        alert('‚úÖ Donn√©es import√©es avec succ√®s !');
                        console.log('‚úÖ JSON import√©:', data);
                        
                        // Marquer le formulaire comme modifi√©
                        formModified = true;
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erreur lors de l\'import:', error);
                    alert('‚ùå Erreur : Le fichier JSON n\'est pas valide ou est corrompu.');
                }
            };
            
            reader.onerror = function() {
                alert('‚ùå Erreur lors de la lecture du fichier');
            };
            
            reader.readAsText(file);
            
            // R√©initialiser l'input pour permettre de r√©importer le m√™me fichier
            e.target.value = '';
        });

        // ============================================
        // CONFIRMATION AVANT FERMETURE
        // ============================================
        let formModified = false;

        document.querySelectorAll('input, textarea').forEach(element => {
            element.addEventListener('input', () => {
                formModified = true;
            });
        });

        window.addEventListener('beforeunload', function(e) {
            if (formModified) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // D√©sactiver le flag apr√®s sauvegarde
        document.getElementById('saveBtn').addEventListener('click', () => {
            setTimeout(() => {
                formModified = false;
            }, 1000);
        });

        // ============================================
        // AUTO-REMPLISSAGE DE LA DATE
        // ============================================
        window.addEventListener('load', function() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            document.getElementById('date').value = `${day}/${month}/${year}`;
        });
    </script>
</body>
</html>
