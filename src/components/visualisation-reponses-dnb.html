<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisation des r√©ponses - DNB Technologie</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-box .number {
            font-size: 2em;
            font-weight: bold;
        }
        
        .stat-box .label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .responses-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 25px;
        }
        
        .response-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .response-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .card-header h3 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }
        
        .card-header .meta {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .question-block {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .question-block h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .answer {
            padding: 8px 12px;
            background: white;
            border-radius: 5px;
            margin: 5px 0;
            border: 1px solid #e0e0e0;
        }
        
        .answer.empty {
            background: #fff3cd;
            color: #856404;
            font-style: italic;
        }
        
        .checkbox-answer {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 3px;
        }
        
        .checkbox-answer.checked {
            background: #d4edda;
            color: #155724;
        }
        
        .checkbox-answer.unchecked {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.5em;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            background: white;
            border-radius: 15px;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .responses-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Visualisation des r√©ponses - DNB Technologie</h1>
        <div class="stats">
            <div class="stat-box">
                <div class="number" id="totalResponses">0</div>
                <div class="label">R√©ponses re√ßues</div>
            </div>
            <div class="stat-box">
                <div class="number" id="lastUpdate">--:--</div>
                <div class="label">Derni√®re mise √† jour</div>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç Rechercher par nom, pr√©nom ou classe...">
        </div>
        <button class="btn btn-primary" onclick="loadResponses()">üîÑ Actualiser</button>
        <button class="btn btn-success" onclick="exportToCSV()">üì• T√©l√©charger CSV</button>
        <button class="btn btn-secondary" onclick="clearSearch()">‚úñ Effacer filtre</button>
    </div>
    
    <div id="loading" class="loading">
        ‚è≥ Chargement des donn√©es...
    </div>
    
    <div id="responsesContainer" class="responses-container" style="display: none;"></div>
    
    <div id="noData" class="no-data" style="display: none;">
        <h2>üì≠ Aucune r√©ponse trouv√©e</h2>
        <p>Les r√©ponses des √©l√®ves s'afficheront ici automatiquement.</p>
    </div>

    <script>
        // Configuration Firebase (identique au formulaire)
        const firebaseConfig = {
            apiKey: "AIzaSyDIvzEk0xKVdRC0r9D_tBGnKPX29Fqkem4",
            authDomain: "form-results-b285b.firebaseapp.com",
            projectId: "form-results-b285b",
            storageBucket: "form-results-b285b.firebasestorage.app",
            messagingSenderId: "662462446647",
            appId: "1:662462446647:web:0fe6315cc0c189185513b2"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allResponses = [];

        // Charger les r√©ponses au d√©marrage
        window.addEventListener('load', () => {
            loadResponses();
        });

        // Fonction de chargement des r√©ponses
        async function loadResponses() {
            console.log('üîç D√©but du chargement des r√©ponses...');
            document.getElementById('loading').style.display = 'block';
            document.getElementById('responsesContainer').style.display = 'none';
            document.getElementById('noData').style.display = 'none';
        
            try {
                console.log('üì° Connexion √† Firestore...');
                const snapshot = await db.collection('dnb_trottinette').orderBy('timestamp', 'desc').get();
                
                console.log('‚úÖ Snapshot re√ßu, nombre de documents:', snapshot.size);
                
                allResponses = [];
                snapshot.forEach(doc => {
                    console.log('üìÑ Document trouv√©:', doc.id, doc.data());
                    allResponses.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
        
                console.log('üìä Total de r√©ponses charg√©es:', allResponses.length);
                displayResponses(allResponses);
                updateStats();
                
            } catch (error) {
                console.error('‚ùå Erreur compl√®te:', error);
                console.error('Code erreur:', error.code);
                console.error('Message:', error.message);
                alert('Erreur lors du chargement des donn√©es: ' + error.message);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('noData').style.display = 'block';
            }
        }


        // Afficher les r√©ponses
        function displayResponses(responses) {
            document.getElementById('loading').style.display = 'none';
            
            if (responses.length === 0) {
                document.getElementById('noData').style.display = 'block';
                return;
            }

            const container = document.getElementById('responsesContainer');
            container.style.display = 'grid';
            container.innerHTML = '';

            responses.forEach(response => {
                const card = createResponseCard(response);
                container.appendChild(card);
            });
        }

        // Cr√©er une carte de r√©ponse
        function createResponseCard(data) {
            const card = document.createElement('div');
            card.className = 'response-card';
            
            const timestamp = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString('fr-FR') : 'Date inconnue';
            
            card.innerHTML = `
                <div class="card-header">
                    <h3>${data.nom_eleve || 'Anonyme'}</h3>
                    <div class="meta">Classe: ${data.classe || 'Non renseign√©e'} | ${timestamp}</div>
                </div>

                <div class="question-block">
                    <h4>Question 1 (4 points) - Avantages et inconv√©nients</h4>
                    <div class="answer ${!data.q1_avantage1 ? 'empty' : ''}">
                        Avantage 1: ${data.q1_avantage1 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q1_avantage2 ? 'empty' : ''}">
                        Avantage 2: ${data.q1_avantage2 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q1_avantage3 ? 'empty' : ''}">
                        Avantage 3: ${data.q1_avantage3 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q1_inconvenient ? 'empty' : ''}">
                        Inconv√©nient: ${data.q1_inconvenient || 'Non r√©pondu'}
                    </div>
                </div>

                <div class="question-block">
                    <h4>Question 2 (7 points) - Solutions techniques</h4>
                    <div class="answer ${!data.q2_avertir ? 'empty' : ''}">
                        Avertir: ${data.q2_avertir || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q2_avancer1 ? 'empty' : ''}">
                        Avancer 1: ${data.q2_avancer1 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q2_avancer2 ? 'empty' : ''}">
                        Avancer 2: ${data.q2_avancer2 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q2_avancer3 ? 'empty' : ''}">
                        Avancer 3: ${data.q2_avancer3 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q2_eclairer1 ? 'empty' : ''}">
                        √âclairer 1: ${data.q2_eclairer1 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q2_eclairer2 ? 'empty' : ''}">
                        √âclairer 2: ${data.q2_eclairer2 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q2_fonction_batterie ? 'empty' : ''}">
                        Fonction batterie: ${data.q2_fonction_batterie || 'Non r√©pondu'}
                    </div>
                </div>

                <div class="question-block">
                    <h4>Question 3 (4 points) - R√®glement</h4>
                    <span class="checkbox-answer ${data.q3_freiner ? 'checked' : 'unchecked'}">
                        Freiner: ${data.q3_freiner ? '‚úì' : '‚úó'}
                    </span>
                    <span class="checkbox-answer ${data.q3_avertir ? 'checked' : 'unchecked'}">
                        Avertir: ${data.q3_avertir ? '‚úì' : '‚úó'}
                    </span>
                    <span class="checkbox-answer ${data.q3_avancer ? 'checked' : 'unchecked'}">
                        Avancer: ${data.q3_avancer ? '‚úì' : '‚úó'}
                    </span>
                    <span class="checkbox-answer ${data.q3_eclairer ? 'checked' : 'unchecked'}">
                        √âclairer: ${data.q3_eclairer ? '‚úì' : '‚úó'}
                    </span>
                    <span class="checkbox-answer ${data.q3_batterie ? 'checked' : 'unchecked'}">
                        Batterie: ${data.q3_batterie ? '‚úì' : '‚úó'}
                    </span>
                    <span class="checkbox-answer ${data.q3_vitesse ? 'checked' : 'unchecked'}">
                        Vitesse: ${data.q3_vitesse ? '‚úì' : '‚úó'}
                    </span>
                </div>

                <div class="question-block">
                    <h4>Question 4 (6 points) - Algorigramme</h4>
                    <div class="answer ${!data.q4_box1 ? 'empty' : ''}">
                        Bo√Æte 1: ${data.q4_box1 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q4_box2 ? 'empty' : ''}">
                        Bo√Æte 2: ${data.q4_box2 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q4_box3 ? 'empty' : ''}">
                        Bo√Æte 3: ${data.q4_box3 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q4_diamond ? 'empty' : ''}">
                        Losange: ${data.q4_diamond || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q4_reponse1 ? 'empty' : ''}">
                        R√©ponse 1: ${data.q4_reponse1 || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q4_reponse2 ? 'empty' : ''}">
                        R√©ponse 2: ${data.q4_reponse2 || 'Non r√©pondu'}
                    </div>
                </div>

                <div class="question-block">
                    <h4>Question 5 (4 points) - Programme</h4>
                    <div class="answer ${!data.q5_autoriser ? 'empty' : ''}">
                        Autoriser: ${data.q5_autoriser || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q5_freinage ? 'empty' : ''}">
                        Freinage demand√©: ${data.q5_freinage || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q5_pas_autoriser ? 'empty' : ''}">
                        Pas autoriser: ${data.q5_pas_autoriser || 'Non r√©pondu'}
                    </div>
                    <div class="answer ${!data.q5_capteur ? 'empty' : ''}">
                        Capteur pr√©sence: ${data.q5_capteur || 'Non r√©pondu'}
                    </div>
                </div>

                <div class="question-block">
                    <h4>Question 6 (5 points) - Stockage d'√©nergie</h4>
                    <div class="answer ${!data.q6_capacite ? 'empty' : ''}">
                        Capacit√©: ${data.q6_capacite || 'Non r√©pondu'} Ah
                    </div>
                    <div class="answer ${!data.q6_tension ? 'empty' : ''}">
                        Tension: ${data.q6_tension || 'Non r√©pondu'} V
                    </div>
                    <div class="answer ${!data.q6_energie ? 'empty' : ''}">
                        √ânergie: ${data.q6_energie || 'Non r√©pondu'} Wh
                    </div>
                    <div class="answer ${!data.q6_duree ? 'empty' : ''}">
                        Dur√©e: ${data.q6_duree || 'Non r√©pondu'} heures
                    </div>
                    <div class="answer ${!data.q6_distance ? 'empty' : ''}">
                        Distance: ${data.q6_distance || 'Non r√©pondu'} km
                    </div>
                </div>
            `;
            
            return card;
        }

        // Mettre √† jour les statistiques
        function updateStats() {
            document.getElementById('totalResponses').textContent = allResponses.length;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('fr-FR');
        }

        // Fonction de recherche
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            const filtered = allResponses.filter(response => {
                const nom = (response.nom_eleve || '').toLowerCase();
                const classe = (response.classe || '').toLowerCase();
                return nom.includes(searchTerm) || classe.includes(searchTerm);
            });
            
            displayResponses(filtered);
        });

        // Effacer la recherche
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            displayResponses(allResponses);
        }

        // Export CSV
        function exportToCSV() {
            if (allResponses.length === 0) {
                alert('Aucune donn√©e √† exporter');
                return;
            }

            // En-t√™tes CSV
            const headers = [
                'Nom', 'Classe', 'Date',
                'Q1_Avantage1', 'Q1_Avantage2', 'Q1_Avantage3', 'Q1_Inconv√©nient',
                'Q2_Avertir', 'Q2_Avancer1', 'Q2_Avancer2', 'Q2_Avancer3', 'Q2_√âclairer1', 'Q2_√âclairer2', 'Q2_Fonction_Batterie',
                'Q3_Freiner', 'Q3_Avertir', 'Q3_Avancer', 'Q3_√âclairer', 'Q3_Batterie', 'Q3_Vitesse',
                'Q4_Box1', 'Q4_Box2', 'Q4_Box3', 'Q4_Diamond', 'Q4_Reponse1', 'Q4_Reponse2',
                'Q5_Autoriser', 'Q5_Freinage', 'Q5_PasAutoriser', 'Q5_Capteur',
                'Q6_Capacit√©', 'Q6_Tension', 'Q6_√ânergie', 'Q6_Dur√©e', 'Q6_Distance'
            ];

            // Construire les lignes
            const rows = allResponses.map(r => {
                const timestamp = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleString('fr-FR') : '';
                
                return [
                    escapeCSV(r.nom_eleve || ''),
                    escapeCSV(r.classe || ''),
                    timestamp,
                    escapeCSV(r.q1_avantage1 || ''),
                    escapeCSV(r.q1_avantage2 || ''),
                    escapeCSV(r.q1_avantage3 || ''),
                    escapeCSV(r.q1_inconvenient || ''),
                    escapeCSV(r.q2_avertir || ''),
                    escapeCSV(r.q2_avancer1 || ''),
                    escapeCSV(r.q2_avancer2 || ''),
                    escapeCSV(r.q2_avancer3 || ''),
                    escapeCSV(r.q2_eclairer1 || ''),
                    escapeCSV(r.q2_eclairer2 || ''),
                    escapeCSV(r.q2_fonction_batterie || ''),
                    r.q3_freiner ? 'OUI' : 'NON',
                    r.q3_avertir ? 'OUI' : 'NON',
                    r.q3_avancer ? 'OUI' : 'NON',
                    r.q3_eclairer ? 'OUI' : 'NON',
                    r.q3_batterie ? 'OUI' : 'NON',
                    r.q3_vitesse ? 'OUI' : 'NON',
                    escapeCSV(r.q4_box1 || ''),
                    escapeCSV(r.q4_box2 || ''),
                    escapeCSV(r.q4_box3 || ''),
                    escapeCSV(r.q4_diamond || ''),
                    escapeCSV(r.q4_reponse1 || ''),
                    escapeCSV(r.q4_reponse2 || ''),
                    escapeCSV(r.q5_autoriser || ''),
                    escapeCSV(r.q5_freinage || ''),
                    escapeCSV(r.q5_pas_autoriser || ''),
                    escapeCSV(r.q5_capteur || ''),
                    escapeCSV(r.q6_capacite || ''),
                    escapeCSV(r.q6_tension || ''),
                    escapeCSV(r.q6_energie || ''),
                    escapeCSV(r.q6_duree || ''),
                    escapeCSV(r.q6_distance || '')
                ].join(';');
            });

            // Cr√©er le contenu CSV
            const csvContent = '\uFEFF' + headers.join(';') + '\n' + rows.join('\n');

            // T√©l√©charger
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `reponses_dnb_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // √âchapper les valeurs CSV
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            value = String(value);
            if (value.includes(';') || value.includes('"') || value.includes('\n')) {
                return '"' + value.replace(/"/g, '""') + '"';
            }
            return value;
        }
    </script>
</body>
</html>
