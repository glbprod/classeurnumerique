<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Firebase vers CSV</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #667eea;
            text-align: center;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            font-weight: bold;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #status {
            text-align: center;
            margin: 20px 0;
            font-size: 14px;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Export Firebase ‚Üí CSV</h1>
        
        <div class="info">
            <strong>Instructions :</strong><br>
            Cliquez sur le bouton ci-dessous pour exporter toutes les r√©ponses des √©l√®ves au format CSV.
        </div>
        
        <button id="exportBtn" onclick="exportToCSV()">
            üì• Exporter les r√©ponses en CSV
        </button>
        
        <div id="status"></div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION FIREBASE (LA M√äME QUE VOTRE FORMULAIRE)
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDIvzEk0xKVdRC0r9D_tBGnKPX29Fqkem4",
            authDomain: "form-results-b285b.firebaseapp.com",
            projectId: "form-results-b285b",
            storageBucket: "form-results-b285b.firebasestorage.app",
            messagingSenderId: "662462446647",
            appId: "1:662462446647:web:0fe6315cc0c189185513b2"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ============================================
        // FONCTION D'EXPORT CSV
        // ============================================
        async function exportToCSV() {
            const btn = document.getElementById('exportBtn');
            const status = document.getElementById('status');
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ R√©cup√©ration des donn√©es...';
                status.textContent = '';
                
                // R√©cup√©rer toutes les donn√©es
                const snapshot = await db.collection('fonction_usage_estime').get();
                
                if (snapshot.empty) {
                    status.innerHTML = '‚ö†Ô∏è Aucune donn√©e trouv√©e dans Firebase.';
                    btn.disabled = false;
                    btn.textContent = 'üì• Exporter les r√©ponses en CSV';
                    return;
                }
                
                status.textContent = `‚úÖ ${snapshot.size} r√©ponse(s) trouv√©e(s). G√©n√©ration du CSV...`;
                
                // En-t√™tes du CSV
                const headers = [
                    'Date/Heure',
                    'Nom √âl√®ve',
                    'Classe',
                    'Ex1 - V√©lo',
                    'Ex1 - Smartphone',
                    'Ex1 - R√©frig√©rateur',
                    'Ex2 - Montre couleur',
                    'Ex2 - Montre heure',
                    'Ex2 - Sac tendance',
                    'Ex2 - Sac transport',
                    'Ex2 - Voiture design',
                    'Ex2 - Voiture transport',
                    'Ex3 - Objet choisi',
                    'Ex3 - Fonction usage',
                    'Ex3 - Fonction estime',
                    'Ex3 - M√™me famille'
                ];
                
                // Cr√©er le contenu CSV
                let csvContent = headers.join(';') + '\n';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Formater la date
                    let dateStr = '';
                    if (data.timestamp) {
                        const date = data.timestamp.toDate();
                        dateStr = date.toLocaleString('fr-FR');
                    } else if (data.date_soumission) {
                        dateStr = new Date(data.date_soumission).toLocaleString('fr-FR');
                    }
                    
                    // Nettoyer les donn√©es (enlever les retours √† la ligne et guillemets)
                    const clean = (str) => {
                        if (!str) return '';
                        return '"' + String(str).replace(/"/g, '""').replace(/\n/g, ' ') + '"';
                    };
                    
                    const row = [
                        clean(dateStr),
                        clean(data.nom_eleve),
                        clean(data.classe),
                        clean(data.ex1_q1),
                        clean(data.ex1_q2),
                        clean(data.ex1_q3),
                        clean(data.ex2_q1),
                        clean(data.ex2_q2),
                        clean(data.ex2_q3),
                        clean(data.ex2_q4),
                        clean(data.ex2_q5),
                        clean(data.ex2_q6),
                        clean(data.ex3_objet),
                        clean(data.ex3_fonction_usage),
                        clean(data.ex3_fonction_estime),
                        clean(data.ex3_meme_famille)
                    ];
                    
                    csvContent += row.join(';') + '\n';
                });
                
                // T√©l√©charger le fichier CSV
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `reponses_eleves_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                status.innerHTML = `‚úÖ Export r√©ussi ! <strong>${snapshot.size} r√©ponse(s)</strong> export√©e(s).`;
                btn.disabled = false;
                btn.textContent = 'üì• Exporter les r√©ponses en CSV';
                
            } catch (error) {
                console.error('Erreur:', error);
                status.innerHTML = `‚ùå Erreur : ${error.message}`;
                btn.disabled = false;
                btn.textContent = 'üì• Exporter les r√©ponses en CSV';
            }
        }
    </script>
</body>
</html>
