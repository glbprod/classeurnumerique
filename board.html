import React, { useState } from 'react';

export default function GithubHtmlCards() {
  const [branch, setBranch] = useState('main');
  const [status, setStatus] = useState('');
  const [cards, setCards] = useState([]);
  const [loading, setLoading] = useState(false);

  const owner = 'glbprod';
  const repo = 'classeurnumerique';
  const basePages = `https://${owner}.github.io/${repo}`;

  const fetchFiles = async () => {
    setLoading(true);
    setStatus('Récupération de la liste des fichiers HTML...');
    setCards([]);

    try {
      // Lister tous les fichiers du dépôt via l’arbre Git (récursif)
      const treeUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
      const treeResp = await fetch(treeUrl);
      if (!treeResp.ok) throw new Error('Erreur API GitHub');
      const treeData = await treeResp.json();

      const htmlFiles = treeData.tree.filter(item => item.path.endsWith('.html'));
      if (htmlFiles.length === 0) {
        setStatus('Aucun fichier HTML trouvé dans ce dépôt.');
        setLoading(false);
        return;
      }

      setStatus(`${htmlFiles.length} fichiers trouvés. Récupération des métadonnées...`);

      // Récupérer la date du dernier commit pour chaque fichier
      const enriched = await Promise.all(htmlFiles.map(async file => {
        const commitsUrl = `https://api.github.com/repos/${owner}/${repo}/commits?path=${file.path}&per_page=1&sha=${branch}`;
        try {
          const cResp = await fetch(commitsUrl);
          const cJson = await cResp.json();
          const date = Array.isArray(cJson) && cJson[0]?.commit?.author?.date ? cJson[0].commit.author.date : null;
          let title = file.path.split('/').pop().replace(/\.html?$/i, '');
          let excerpt = '';

          try {
            const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${file.path}`;
            const rawResp = await fetch(rawUrl);
            if (rawResp.ok) {
              const text = await rawResp.text();
              const tMatch = text.match(/<title[^>]*>([^<]+)<\\/title>/i);
              if (tMatch) title = tMatch[1].trim();
              else {
                const h1 = text.match(/<h1[^>]*>([^<]+)<\\/h1>/i);
                if (h1) title = h1[1].trim();
              }
              const bMatch = text.replace(/<script[\\s\\S]*?<\\/script>/gi, '').replace(/<style[\\s\\S]*?<\\/style>/gi, '').replace(/<[^>]+>/g, ' ');
              excerpt = bMatch.trim().split(/\\s+/).slice(0, 25).join(' ');
            }
          } catch {}

          return { file, date, title, excerpt };
        } catch {
          return { file, date: null, title: file.path, excerpt: '' };
        }
      }));

      enriched.sort((a, b) => {
        const da = a.date ? new Date(a.date).getTime() : 0;
        const db = b.date ? new Date(b.date).getTime() : 0;
        return db - da;
      });

      setCards(enriched);
      setStatus('Terminé.');
    } catch (e) {
      setStatus(`Erreur : ${e.message}`);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-6 min-h-screen bg-gray-50">
      <h1 className="text-2xl font-bold mb-4">Fichiers HTML du dépôt {repo}</h1>
      <div className="flex gap-3 mb-6 flex-wrap items-end">
        <label className="flex flex-col">
          Branche
          <input
            value={branch}
            onChange={e => setBranch(e.target.value)}
            className="border rounded-lg px-2 py-1 text-sm"
          />
        </label>
        <button
          onClick={fetchFiles}
          disabled={loading}
          className="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 text-sm disabled:opacity-50"
        >
          {loading ? 'Chargement...' : 'Mettre à jour'}
        </button>
      </div>

      <div className="text-gray-700 mb-4">{status}</div>

      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {cards.map((item, i) => (
          <div key={i} className="bg-white p-4 rounded-2xl shadow-md flex flex-col gap-2">
            <h3 className="font-semibold text-lg">{item.title}</h3>
            <div className="text-sm text-gray-500">
              {item.date ? new Date(item.date).toLocaleString() : 'Date inconnue'}
            </div>
            <p className="text-sm text-gray-700 flex-1">{item.excerpt}</p>
            <div className="flex gap-2 mt-2">
              <a
                href={`https://github.com/${owner}/${repo}/blob/${branch}/${item.file.path}`}
                target="_blank"
                rel="noopener noreferrer"
                className="text-sm text-blue-600 hover:underline"
              >
                Voir sur GitHub
              </a>
              <a
                href={`${basePages}/${item.file.path}`}
                target="_blank"
                rel="noopener noreferrer"
                className="text-sm text-green-600 hover:underline"
              >
                Ouvrir la page
              </a>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
